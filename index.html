<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ±å›´æ£‹ | iWeiQi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #d4a017; --wood: #eebb76; --bg: #f4f6f8; --radius: 8px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        header { background: #fff; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 99; }
        .logo { font-size: 1.2rem; font-weight: bold; text-decoration: none; color: #333; }
        .nav-btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        
        .hero-card { background: #fff; border-radius: var(--radius); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* --- é¦–é¡µå¯¹å±€ä¿¡æ¯å¤´ (ä¿®å¤ç‚¹ 1) --- */
        .game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 10px; 
        }
        .vs-text { font-size: 1.1rem; font-weight: bold; }
        .event-text { font-size: 0.9rem; color: #666; }

        /* æ‰‹æœºç«¯å¼ºåˆ¶ä¸Šä¸‹æ’åˆ— */
        @media (max-width: 600px) {
            .game-header { flex-direction: column; align-items: flex-start; gap: 5px; }
            .event-text { margin-top: 2px; }
        }

        .board-wrapper { width: 100%; max-width: 600px; aspect-ratio: 1/1; margin: 0 auto; background: var(--wood); border-radius: 2px; }
        canvas { width: 100%; height: 100%; display: block; }
        
        .search-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: var(--radius); }
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .btn-search { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .list-section { background: #fff; border-radius: var(--radius); overflow: hidden; }
        .game-item { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .game-item:hover { background: #f0f7ff; }
        .win { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">âš«âšª çˆ±å›´æ£‹</a>
    <div id="auth-box"></div>
</header>

<div class="container">
    <div style="margin-bottom:5px; font-weight:bold; color:#555;">ğŸ”¥ æœ¬æ—¥æ¨è</div>
    <div class="hero-card">
        <div class="game-header">
            <!-- ä¸Šä¸‹ç»“æ„ä¼˜åŒ– -->
            <div class="vs-text"><span id="h-black">--</span> (B) vs <span id="h-white">--</span> (W)</div>
            <div class="event-text"><span id="h-event">Loading...</span> Â· <span id="h-result"></span></div>
        </div>
        <div class="board-wrapper"><canvas id="main-board"></canvas></div>
        <div style="text-align: center; margin-top: 15px;">
            <a id="enter-btn" href="#"><button class="btn-search" style="background:var(--primary)">è¿›å…¥è¯¦æƒ… / çŒœå±€</button></a>
        </div>
    </div>

    <div class="search-bar">
        <input type="text" class="inp" id="k-word" placeholder="æ£‹æ‰‹ / èµ›äº‹...">
        <button class="btn-search" onclick="doSearch()">æœç´¢</button>
    </div>

    <div class="list-section">
        <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #eee; font-weight:bold;">ğŸ“š æœ€æ–°å½•å…¥ (Top 10)</div>
        <div id="game-list">Loading...</div>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/core.js"></script>
<script>
    const board = new GoBoard('main-board');
    const engine = new GoEngine();

    window.onload = async () => {
        renderHeaderAuth('auth-box');
        await loadData();
    };

    async function loadData(filters = {}) {
        const list = document.getElementById('game-list');
        list.innerHTML = '<div style="padding:20px;text-align:center">Loading...</div>';

        let q = sbClient.from('games').select('*').order('game_date', {ascending: false}).limit(20);
        if (filters.word) q = q.or(`black_player.ilike.%${filters.word}%,white_player.ilike.%${filters.word}%,event_name.ilike.%${filters.word}%`);

        const { data, error } = await q;

        if (error || !data || data.length === 0) {
            list.innerHTML = '<div style="padding:20px;text-align:center">æš‚æ— æ•°æ®</div>';
            return;
        }

        const top = data[0];
        document.getElementById('h-black').innerText = top.black_player;
        document.getElementById('h-white').innerText = top.white_player;
        document.getElementById('h-event').innerText = top.event_name;
        document.getElementById('h-result').innerText = top.result;
        document.getElementById('enter-btn').href = `game/#${top.id}`;
        
        const parsed = parseSGF(top.sgf_content);
        engine.reset();
        parsed.moves.forEach(m => engine.play(m.x, m.y, m.c));
        board.draw(engine.board, parsed.moves[parsed.moves.length-1]);

        list.innerHTML = data.slice(0, 10).map(g => `
            <div class="game-item">
                <div>
                    <a href="game/#${g.id}" style="font-weight:bold; color:#333; text-decoration:none">${g.black_player} vs ${g.white_player}</a>
                    <div style="font-size:0.85rem; color:#888">ğŸ“… ${g.game_date} Â· ${g.event_name}</div>
                </div>
                <div class="${g.result && g.result.includes('+') ? 'win' : ''}">${g.result}</div>
            </div>
        `).join('');
    }

    function doSearch() {
        loadData({ word: document.getElementById('k-word').value });
    }
</script>
</body>
</html>
