<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡ç‹æ£‹è°± SGF æ¸…æ´—å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            justify_content: center;
        }
        .container {
            background-color: #fff;
            width: 900px;
            max-width: 100%;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .desc {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .box {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }
        textarea {
            width: 100%;
            height: 180px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 13px;
            resize: vertical;
            box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢paddingæ’‘ç ´å®½åº¦ */
            outline: none;
            transition: border-color 0.2s;
        }
        textarea:focus {
            border-color: #2196F3;
        }
        .btn-area {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-clean {
            background-color: #2196F3;
            color: white;
            margin-right: 10px;
        }
        .btn-clean:hover {
            background-color: #1976D2;
        }
        .btn-copy {
            background-color: #4CAF50;
            color: white;
            display: none; /* åˆå§‹éšè— */
        }
        .btn-copy:hover {
            background-color: #388E3C;
        }
        #status {
            text-align: center;
            height: 20px;
            font-size: 14px;
            margin-top: 5px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>

<div class="container">
    <h1>é‡ç‹ SGF æ£‹è°±æ¸…æ´—å™¨</h1>
    <p class="desc">å°†é‡ç‹ç½‘é¡µæºç ä¸­çš„ SGF æ–‡æœ¬ç²˜è´´åˆ°ä¸‹æ–¹ï¼Œä¸€é”®å»é™¤ AI å˜åŒ–å›¾å’Œå¤šä½™åµŒå¥—ã€‚</p>

    <div class="box">
        <label for="inputSgf">1. ç²˜è´´åŸå§‹æ–‡æœ¬ (åŒ…å« ((...)) ç­‰å¤æ‚ç»“æ„):</label>
        <textarea id="inputSgf" placeholder="ä¾‹å¦‚ï¼š(;GM[1]... (;B[aa](;W[bb])..."></textarea>
    </div>

    <div class="btn-area">
        <button class="btn-clean" onclick="processSGF()">âš¡ å¼€å§‹æ¸…æ´— (åªç•™ä¸»å¹²)</button>
        <button class="btn-copy" id="btnCopy" onclick="copyResult()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </div>
    <div id="status"></div>

    <div class="box">
        <label for="outputSgf">2. æ¸…æ´—ç»“æœ (æ‰å¹³åŒ–æ ¼å¼):</label>
        <textarea id="outputSgf" readonly placeholder="æ¸…æ´—åçš„æ£‹è°±å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
    </div>
</div>

<script>
    /**
     * æ ¸å¿ƒè§£æå‡½æ•°ï¼šéå†å­—ç¬¦ï¼Œå‰”é™¤åˆ†æ”¯ï¼Œå»é™¤åµŒå¥—æ‹¬å·
     */
    function cleanSgfMainLine(sgfContent) {
        let result = [];
        let length = sgfContent.length;
        let i = 0;

        let depth = 0;
        // è®°å½•æŸä¸€å±‚çº§æ˜¯å¦å·²ç»èµ°è¿‡ä¸»å¹²åˆ†æ”¯
        let branchTaken = {}; 
        // è·³è¿‡æ ‡è®°ï¼šå¦‚æœä¸ä¸ºnullï¼Œè¡¨ç¤ºå½“å‰æ·±åº¦å¤§äºæ­¤å€¼æ—¶éƒ½éœ€è¦è·³è¿‡ï¼ˆå› ä¸ºåœ¨æ—æ”¯é‡Œï¼‰
        let skipThreshold = null;

        let inPropValue = false; // æ˜¯å¦åœ¨ [...] å±æ€§å€¼å†…
        let escapeNext = false;  // æ˜¯å¦æ˜¯è½¬ä¹‰å­—ç¬¦

        while (i < length) {
            let char = sgfContent[i];

            // --- 1. å¤„ç†å±æ€§å€¼ [...] å†…éƒ¨ (å¿½ç•¥å†…éƒ¨çš„ç»“æ„ç¬¦å·) ---
            if (inPropValue) {
                if (escapeNext) {
                    if (skipThreshold === null) result.push(char);
                    escapeNext = false;
                } else {
                    if (char === '\\') {
                        if (skipThreshold === null) result.push(char);
                        escapeNext = true;
                    } else if (char === ']') {
                        if (skipThreshold === null) result.push(char);
                        inPropValue = false;
                    } else {
                        if (skipThreshold === null) result.push(char);
                    }
                }
                i++;
                continue;
            }

            // --- 2. å¤„ç†ç»“æ„ç¬¦å· ---
            if (char === '[') {
                inPropValue = true;
                if (skipThreshold === null) result.push(char);

            } else if (char === '(') {
                // é‡åˆ°å·¦æ‹¬å·
                if (skipThreshold !== null) {
                    // å·²ç»åœ¨è·³è¿‡æ¨¡å¼ï¼Œä»…å¢åŠ æ·±åº¦
                    depth++;
                } else {
                    // æ­£å¸¸æ¨¡å¼
                    if (branchTaken[depth]) {
                        // è¿™ä¸€å±‚å·²ç»èµ°è¿‡ä¸»è·¯äº†ï¼Œç°åœ¨çš„ '(' æ˜¯å…„å¼Ÿåˆ†æ”¯ï¼ˆå˜æ‹›ï¼‰ï¼Œå¼€å§‹è·³è¿‡
                        skipThreshold = depth + 1;
                        depth++;
                    } else {
                        // è¿™æ˜¯è¿™ä¸€å±‚çš„ä¸»è·¯
                        branchTaken[depth] = true;
                        // è¿›å…¥ä¸‹ä¸€å±‚å‰ï¼Œæ¸…é™¤ä¸‹ä¸€å±‚çš„è®°å½•
                        if (branchTaken[depth + 1]) delete branchTaken[depth + 1];
                        
                        depth++;
                        // ã€æ‰å¹³åŒ–å…³é”®ã€‘ï¼šä¸å°† '(' åŠ å…¥ç»“æœ
                    }
                }

            } else if (char === ')') {
                // é‡åˆ°å³æ‹¬å·
                if (skipThreshold !== null) {
                    // æ­£åœ¨è·³è¿‡
                    depth--;
                    // å¦‚æœé€€å›åˆ°äº†å¼€å§‹è·³è¿‡çš„å±‚çº§ï¼Œç»“æŸè·³è¿‡
                    if (depth < skipThreshold) {
                        skipThreshold = null;
                    }
                } else {
                    // æ­£å¸¸æ¨¡å¼ï¼Œé€€å‡ºä¸€å±‚
                    depth--;
                    // ã€æ‰å¹³åŒ–å…³é”®ã€‘ï¼šä¸å°† ')' åŠ å…¥ç»“æœ
                }

            } else if (char === ';') {
                // èŠ‚ç‚¹ç¬¦å·
                if (skipThreshold === null) result.push(char);

            } else {
                // å…¶ä»–å­—ç¬¦ï¼ˆå±æ€§åã€æ¢è¡Œç¬¦ç­‰ï¼‰
                if (skipThreshold === null) result.push(char);
            }

            i++;
        }

        // æ‹¼æ¥å­—ç¬¦ä¸²
        let flatBody = result.join("").trim();
        
        // ç¡®ä¿ç»“æœä»¥ ; å¼€å¤´
        if (flatBody.length > 0 && flatBody[0] !== ';') {
            flatBody = ";" + flatBody;
        }

        // åŠ ä¸Šå”¯ä¸€çš„å¤´å°¾æ‹¬å·
        return "(" + flatBody + ")";
    }

    function processSGF() {
        const input = document.getElementById('inputSgf').value;
        const outputArea = document.getElementById('outputSgf');
        const statusDiv = document.getElementById('status');
        const btnCopy = document.getElementById('btnCopy');

        if (!input.trim()) {
            statusDiv.textContent = "è¯·å…ˆç²˜è´´å†…å®¹ï¼";
            statusDiv.className = "error";
            return;
        }

        try {
            // å°è¯•ç®€å•æå–ï¼Œå¦‚æœåŒ…å«HTMLæ ‡ç­¾ï¼Œå°è¯•å®šä½ id="player-container"
            // ä½†ç”¨æˆ·å¯èƒ½ç›´æ¥ç²˜è´´çº¯æ–‡æœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å¤„ç†è¾“å…¥æ¡†çš„å†…å®¹
            // åªæ˜¯ä¸ºäº†ä¿é™©ï¼Œå¦‚æœç²˜è´´çš„æ˜¯æ•´æ®µHTMLï¼Œæˆ‘ä»¬æ­£åˆ™æå–ä¸€ä¸‹
            let rawSgf = input;
            
            // å¦‚æœçœ‹èµ·æ¥åƒ HTML
            if (input.includes('<html') || input.includes('id="player-container"')) {
                const match = input.match(/id="player-container"[^>]*>\s*(.*?)\s*<\/div>/is);
                if (match && match[1]) {
                    rawSgf = match[1].trim();
                } else {
                    // å¤‡ç”¨ï¼šæ‰¾ (;GM
                    const matchGM = input.match(/(\(;GM\[1\].+)/s);
                    if (matchGM && matchGM[1]) {
                        // æ¸…ç†å¯èƒ½çš„å°¾éƒ¨ div
                        rawSgf = matchGM[1].split('</div>')[0].trim();
                    }
                }
            }

            const cleanResult = cleanSgfMainLine(rawSgf);
            outputArea.value = cleanResult;
            
            statusDiv.textContent = "æ¸…æ´—æˆåŠŸï¼å·²ç§»é™¤å¤šä½™åˆ†æ”¯ã€‚";
            statusDiv.className = "success";
            btnCopy.style.display = "inline-block";

        } catch (e) {
            console.error(e);
            statusDiv.textContent = "å¤„ç†å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚";
            statusDiv.className = "error";
        }
    }

    function copyResult() {
        const outputArea = document.getElementById('outputSgf');
        outputArea.select();
        document.execCommand('copy');
        
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼";
        setTimeout(() => {
            statusDiv.textContent = "æ¸…æ´—æˆåŠŸï¼å·²ç§»é™¤å¤šä½™åˆ†æ”¯ã€‚";
        }, 2000);
    }
</script>

</body>
</html>