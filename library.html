<!-- library.html å®Œæ•´ä»£ç  (æ›¿æ¢åŸæœ‰æ–‡ä»¶) -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£‹è°±åº“ - çˆ±å›´æ£‹</title>
    <link rel="stylesheet" href="./assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #d4a017; --bg: #f4f6f8; --radius: 8px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #333; padding-bottom: 40px;}
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        header { background: #fff; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 99; }
        .logo { font-size: 1.2rem; font-weight: bold; text-decoration: none; color: #333; }
        .nav-btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.9rem;}
        
        /* æœç´¢æ å‡çº§ */
        .search-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: var(--radius); border: 1px solid #eee;}
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; min-width: 140px; }
        .btn-search { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .library-box { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid #eee; min-height: 400px;}
        .list-header { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .game-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: background 0.1s;}
        .game-row:hover { background: #f0f7ff; cursor: pointer; }
        .game-info { flex: 1; }
        .game-title { font-weight: bold; font-size: 1.05rem; color: #2c3e50; margin-bottom: 4px; }
        .game-meta { font-size: 0.85rem; color: #888; }
        .game-result { font-weight: bold; margin-left: 10px; min-width: 60px; text-align: right; }
        .win { color: #e74c3c; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; margin-top: 10px; }
        .p-btn { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .p-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
    </style>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6ae297c0516ef1d9c8f76bf2abca886";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
</head>
<body>

<header>
    <a href="index.html" class="logo">âš«âšª çˆ±å›´æ£‹</a>
    <div id="auth-box"></div>
</header>

<div class="container">
    <h2 style="margin-top:0; border-bottom:2px solid var(--primary); padding-bottom:10px;">ğŸ—‚ï¸ æ£‹è°±åº“</h2>

    <!-- æœç´¢æ  (å‡çº§) -->
    <div class="search-bar">
        <input type="text" class="inp" id="keyword" placeholder="æœç´¢æ£‹æ‰‹ã€èµ›äº‹..." style="flex:2">
        <input type="date" class="inp" id="date-start" title="å¼€å§‹æ—¥æœŸ">
        <input type="date" class="inp" id="date-end" title="ç»“æŸæ—¥æœŸ">
        <button class="btn-search" onclick="search(true)">æœç´¢</button>
    </div>

    <div class="library-box">
        <div class="list-header">
            <span>å…¨éƒ¨æ£‹è°±</span>
            <span id="total-count" style="font-weight:normal; font-size:0.85rem; color:#666">...</span>
        </div>
        <div id="list-container"><div style="padding:40px; text-align:center; color:#999;">Loading...</div></div>
    </div>

    <div class="pagination">
        <button class="p-btn" onclick="prevPage()" id="btn-prev">ä¸Šä¸€é¡µ</button>
        <span style="font-size:0.9rem; color:#666">ç¬¬ <span id="cur-page">1</span> é¡µ</span>
        <button class="p-btn" onclick="nextPage()" id="btn-next">ä¸‹ä¸€é¡µ</button>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script>
    const PAGE_SIZE = 20;
    let currentPage = 1, totalItems = 0;

    window.onload = async () => {
        renderHeaderAuth('auth-box');
        await loadPage(1);
    };

    async function loadPage(page) {
        document.getElementById('list-container').innerHTML = '<div style="padding:40px; text-align:center; color:#999;">Loading...</div>';
        currentPage = page;
        
        // è·å–æœç´¢æ¡ä»¶
        const keyword = document.getElementById('keyword').value.trim();
        const dStart = document.getElementById('date-start').value;
        const dEnd = document.getElementById('date-end').value;

        // æ„å»ºæŸ¥è¯¢
        let query = sbClient.from('games').select('id, black_player, white_player, event_name, game_date, result', { count: 'exact' })
            .order('game_date', { ascending: false })
            .range((page - 1) * PAGE_SIZE, page * PAGE_SIZE - 1);

        if (keyword) query = query.or(`black_player.ilike.%${keyword}%,white_player.ilike.%${keyword}%,event_name.ilike.%${keyword}%`);
        if (dStart) query = query.gte('game_date', dStart);
        if (dEnd) query = query.lte('game_date', dEnd);

        const { data, count, error } = await query;
        if (error) return alert(error.message);

        totalItems = count || 0;
        renderList(data);
        updatePagination();
    }

    function renderList(games) {
        const container = document.getElementById('list-container');
        if (!games || games.length === 0) return container.innerHTML = '<div style="padding:40px; text-align:center;">æš‚æ— æ•°æ®</div>';
        container.innerHTML = games.map(g => `
            <div class="game-row" onclick="window.open('game/#${g.id}', '_blank')">
                <div class="game-info">
                    <div class="game-title">${g.black_player} vs ${g.white_player}</div>
                    <div class="game-meta">ğŸ“… ${g.game_date} Â· ${g.event_name}</div>
                </div>
                <div class="game-result ${g.result && g.result.includes('+') ? 'win' : ''}">${g.result}</div>
            </div>
        `).join('');
    }

    function updatePagination() {
        document.getElementById('total-count').innerText = `å…± ${totalItems} å±€`;
        document.getElementById('cur-page').innerText = currentPage;
        document.getElementById('btn-prev').disabled = (currentPage <= 1);
        document.getElementById('btn-next').disabled = (currentPage >= Math.ceil(totalItems / PAGE_SIZE));
    }

    function search() { loadPage(1); }
    function prevPage() { if (currentPage > 1) loadPage(currentPage - 1); }
    function nextPage() { if (currentPage < Math.ceil(totalItems / PAGE_SIZE)) loadPage(currentPage + 1); }
</script>
    <!-- åº•éƒ¨ç‰ˆæƒä¿¡æ¯ -->
    <footer>
        <div class="copyright">
            &copy; 2025 <span style="font-weight:bold;">çˆ±å›´æ£‹ (iWeiQi)</span> | iloveweiqi.com
        </div>
        <div>
            <a href="javascript:void(0)">å…³äºæˆ‘ä»¬</a> | 
            <a href="javascript:void(0)">å…è´£å£°æ˜</a> | 
            <a href="mailto:iloveweiqi@outlook.com">è”ç³»ç®¡ç†å‘˜</a>
        </div>
        <div>
            <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010602004089" target="_blank" style="margin-right:30px;">
                <img src="assets/img/beian.png" /><span>æ²ªå…¬ç½‘å®‰å¤‡ 31010602006089å·</span>
            </a>ICPç»è¥è®¸å¯è¯ï¼š<a href="http://beian.miit.gov.cn/" target="_blank">æ²ªICPå¤‡15029680å·</a>
        </div>
    </footer>
</body>
</html>
