<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£‹è°±åº“ - çˆ±å›´æ£‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #d4a017; --bg: #f4f6f8; --radius: 8px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #333; padding-bottom: 40px;}
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* å¯¼èˆªæ  */
        header { background: #fff; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 99; }
        .logo { font-size: 1.2rem; font-weight: bold; text-decoration: none; color: #333; }
        .nav-btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.9rem;}
        
        /* æœç´¢æ  */
        .search-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: var(--radius); border: 1px solid #eee;}
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .btn-search { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* åˆ—è¡¨å®¹å™¨ */
        .library-box { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid #eee; min-height: 400px;}
        .list-header { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        
        /* å•è¡Œæ ·å¼ */
        .game-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; transition: background 0.1s;}
        .game-row:hover { background: #f0f7ff; cursor: pointer; }
        .game-info { flex: 1; }
        .game-title { font-weight: bold; font-size: 1.05rem; color: #2c3e50; margin-bottom: 4px; }
        .game-meta { font-size: 0.85rem; color: #888; }
        .game-result { font-weight: bold; margin-left: 10px; min-width: 60px; text-align: right; }
        .win { color: #e74c3c; }

        /* åˆ†é¡µæ§ä»¶ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; margin-top: 10px; }
        .p-btn { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
        .p-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }
        .p-info { font-size: 0.9rem; color: #666; }
        .p-jump { width: 50px; padding: 6px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">âš«âšª çˆ±å›´æ£‹</a>
    <div id="auth-box"></div>
</header>

<div class="container">
    <h2 style="margin-top:0; border-bottom:2px solid var(--primary); padding-bottom:10px;">ğŸ—‚ï¸ æ£‹è°±åº“ (Library)</h2>

    <!-- æœç´¢ -->
    <div class="search-bar">
        <input type="text" class="inp" id="keyword" placeholder="æœç´¢æ£‹æ‰‹ã€èµ›äº‹...">
        <button class="btn-search" onclick="search(true)">æœç´¢</button>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="library-box">
        <div class="list-header">
            <span>å…¨éƒ¨æ£‹è°±</span>
            <span id="total-count" style="font-weight:normal; font-size:0.85rem; color:#666">...</span>
        </div>
        <div id="list-container">
            <div style="padding:40px; text-align:center; color:#999;">Loading...</div>
        </div>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination">
        <button class="p-btn" onclick="prevPage()" id="btn-prev">ä¸Šä¸€é¡µ</button>
        <span class="p-info">
            ç¬¬ <span id="cur-page">1</span> / <span id="total-page">1</span> é¡µ
        </span>
        <button class="p-btn" onclick="nextPage()" id="btn-next">ä¸‹ä¸€é¡µ</button>
        
        <!-- è·³è½¬ -->
        <div style="margin-left: 15px; display: flex; align-items: center; gap: 5px;">
            <input type="number" class="p-jump" id="jump-input" min="1">
            <button class="p-btn" onclick="jumpTo()" style="padding: 6px 10px;">Go</button>
        </div>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script>
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let totalItems = 0;
    let currentKeyword = "";

    window.onload = async () => {
        renderHeaderAuth('auth-box');
        await loadPage(1);
    };

    // åŠ è½½æŒ‡å®šé¡µæ•°æ®
    async function loadPage(page) {
        const list = document.getElementById('list-container');
        list.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">æ­£åœ¨åŠ è½½...</div>';
        
        currentPage = page;
        const from = (page - 1) * PAGE_SIZE;
        const to = from + PAGE_SIZE - 1;

        // æ„å»ºæŸ¥è¯¢ï¼šåŒæ—¶è·å–æ•°æ®å’Œæ€»æ•°
        let query = sbClient
            .from('games')
            .select('id, black_player, white_player, event_name, game_date, result', { count: 'exact' })
            .order('game_date', { ascending: false })
            .range(from, to);

        if (currentKeyword) {
            query = query.or(`black_player.ilike.%${currentKeyword}%,white_player.ilike.%${currentKeyword}%,event_name.ilike.%${currentKeyword}%`);
        }

        const { data, count, error } = await query;

        if (error) {
            list.innerHTML = `<div style="padding:20px; color:red; text-align:center">Error: ${error.message}</div>`;
            return;
        }

        totalItems = count || 0;
        renderList(data);
        updatePagination();
    }

    // æ¸²æŸ“åˆ—è¡¨ HTML
    function renderList(games) {
        const container = document.getElementById('list-container');
        if (!games || games.length === 0) {
            container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ£‹è°±</div>';
            return;
        }

        container.innerHTML = games.map(g => `
            <div class="game-row" onclick="window.open('game/#${g.id}', '_blank')">
                <div class="game-info">
                    <div class="game-title">${g.black_player} vs ${g.white_player}</div>
                    <div class="game-meta">ğŸ“… ${g.game_date} Â· ${g.event_name || 'æœªçŸ¥èµ›äº‹'}</div>
                </div>
                <div class="game-result ${g.result && g.result.includes('+') ? 'win' : ''}">${g.result}</div>
            </div>
        `).join('');
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
    function updatePagination() {
        const totalPages = Math.ceil(totalItems / PAGE_SIZE) || 1;
        
        document.getElementById('total-count').innerText = `å…± ${totalItems} å±€`;
        document.getElementById('cur-page').innerText = currentPage;
        document.getElementById('total-page').innerText = totalPages;
        
        document.getElementById('btn-prev').disabled = (currentPage <= 1);
        document.getElementById('btn-next').disabled = (currentPage >= totalPages);
    }

    // æ“ä½œå‡½æ•°
    function search(resetPage = true) {
        currentKeyword = document.getElementById('keyword').value.trim();
        if (resetPage) currentPage = 1;
        loadPage(currentPage);
    }

    function prevPage() {
        if (currentPage > 1) loadPage(currentPage - 1);
    }

    function nextPage() {
        const totalPages = Math.ceil(totalItems / PAGE_SIZE);
        if (currentPage < totalPages) loadPage(currentPage + 1);
    }

    function jumpTo() {
        const val = parseInt(document.getElementById('jump-input').value);
        const totalPages = Math.ceil(totalItems / PAGE_SIZE);
        if (val >= 1 && val <= totalPages) {
            loadPage(val);
        } else {
            alert(`è¯·è¾“å…¥ 1 - ${totalPages} ä¹‹é—´çš„é¡µç `);
        }
    }
</script>
</body>
</html>
