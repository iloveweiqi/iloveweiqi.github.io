<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- é»˜è®¤æ ‡é¢˜ï¼ŒåŠ è½½æ•°æ®åä¼šè¢«JSè¦†ç›– -->
    <title>åŠ è½½ä¸­... - çˆ±å›´æ£‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #d4a017; --bg: #f4f6f8; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 30px; }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: #fff; height: 50px; display: flex; align-items: center; padding: 0 15px; margin-bottom: 10px; border-bottom:1px solid #eee; }
        .back { text-decoration: none; color: #555; font-size: 0.9rem; }
        
        /* ä¿¡æ¯å¡ç‰‡ */
        .info-card { background: #fff; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card h2 { margin: 0 0 5px 0; font-size: 1.3rem; }
        .meta-info { color:#666; font-size: 0.9rem; }

        /* æ£‹ç›˜ */
        .board-box { width: 100%; aspect-ratio: 1/1; background: #eebb76; position: relative; margin-bottom: 15px; border-radius: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        canvas { width: 100%; height: 100%; cursor: pointer; }
        
        /* æµ®å±‚æç¤º */
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s; font-weight: bold; }
        
        /* æ§åˆ¶åŒº */
        .controls { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabs { display: flex; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; background: #f9f9f9; font-size: 0.9rem; }
        .tab.active { background: var(--primary); color: #fff; }
        
        .btns { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-size: 1.2rem; cursor: pointer; }
        .btn:active { background: #eee; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="back">â€¹ è¿”å›é¦–é¡µ</a>
    <!-- å¦‚æœä½ æƒ³åœ¨ Header å³ä¾§æ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼Œå¯ä»¥æŠŠ HeaderAuth é€»è¾‘åŠ åœ¨è¿™é‡Œ -->
    <div style="margin-left:auto; font-size:0.8rem; color:#999;" id="auth-box"></div>
</header>

<div class="container">
    <div class="info-card">
        <h2><span id="p-black">--</span> vs <span id="p-white">--</span></h2>
        <div class="meta-info"><span id="p-event">--</span> Â· <span id="p-result">--</span></div>
    </div>

    <div class="board-box">
        <canvas id="game-canvas"></canvas>
        <div id="msg" class="overlay">Correct!</div>
    </div>

    <div class="controls">
        <div class="tabs">
            <div class="tab active" onclick="setMode('view')" id="t-view">æµè§ˆ (View)</div>
            <div class="tab" onclick="setMode('guess')" id="t-guess">çŒœå±€ (Guess)</div>
            <div class="tab" onclick="setMode('try')" id="t-try">è¯•ä¸‹ (Try)</div>
        </div>

        <div class="btns" id="play-btns">
            <button class="btn" onclick="nav.first()">|â€¹</button>
            <button class="btn" onclick="nav.prev()">â€¹</button>
            <button class="btn" onclick="nav.next()">â€º</button>
            <button class="btn" onclick="nav.last()">â€º|</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
            <span>æ‰‹æ•°: <span id="step-num" style="font-weight:bold">0</span></span>
            <button onclick="downloadSGF()" style="border:none; background:none; color:#666; text-decoration:underline; cursor:pointer">ğŸ“¥ ä¸‹è½½ SGF</button>
        </div>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/core.js"></script>
<script>
    const board = new GoBoard('game-canvas');
    const engine = new GoEngine();
    
    // å…¨å±€çŠ¶æ€
    let moves = [];
    let curStep = 0;
    let mode = 'view';
    let tryHist = [];
    let meta = {};
    let sgfStr = "";

    // éŸ³æ•ˆ
    const sndMove = new Audio('assets/sound/move.wav');
    const sndEat = new Audio('assets/sound/deadstoneless.wav');

    // åˆå§‹åŒ–
    window.onload = async () => {
        // æ¸²æŸ“ Header ç™»å½•çŠ¶æ€ (å¦‚æœä½ åœ¨ config.js é‡Œå†™äº† renderHeaderAuth)
        if(typeof renderHeaderAuth === 'function') renderHeaderAuth('auth-box');

        const id = new URLSearchParams(window.location.search).get('id');
        if(!id) {
            alert('æ— æ•ˆçš„æ£‹è°±ID');
            return location.href = "index.html";
        }
        
        // 1. è·å–æ•°æ®
        const { data, error } = await sbClient.from('games').select('*').eq('id', id).single();
        if(error || !data) { 
            alert('è¯»å–æ£‹è°±å¤±è´¥: ' + (error?.message || 'ä¸å­˜åœ¨')); 
            return; 
        }

        // 2. è§£æ SGF
        sgfStr = data.sgf_content;
        const res = parseSGF(sgfStr);
        moves = res.moves;
        meta = res.meta;
        
        // 3. æ›´æ–°ç•Œé¢æ–‡å­—
        document.getElementById('p-black').innerText = data.black_player;
        document.getElementById('p-white').innerText = data.white_player;
        document.getElementById('p-event').innerText = data.event_name || 'Unknown Event';
        document.getElementById('p-result').innerText = data.result || 'Unknown';

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåŠ¨æ€è®¾ç½®ç½‘é¡µæ ‡é¢˜ â˜…â˜…â˜…
        // æ ¼å¼ï¼šXXX vs XXX - ç»“æœ - èµ›äº‹åç§°
        document.title = `${data.black_player} vs ${data.white_player} - ${data.result} - ${data.event_name}`;

        // 4. æ¸²æŸ“æ£‹ç›˜
        updateBoard();

        // 5. ç»‘å®šç‚¹å‡»äº‹ä»¶
        board.clickHandler = (x, y) => handleClick(x, y);
    };

    // --- äº¤äº’é€»è¾‘ ---

    function handleClick(x, y) {
        if(mode === 'view') return;

        if(mode === 'guess') {
            if(curStep >= moves.length) return showMsg("æ£‹è°±å·²ç»“æŸ");
            const next = moves[curStep];
            if(next.x === x && next.y === y) {
                showMsg("Correct!", true);
                nav.next();
            } else {
                showMsg("Wrong!");
            }
        }
        else if(mode === 'try') {
            let color = 1; // é»˜è®¤ä¸ºé»‘
            // ç®€å•åˆ¤æ–­å½“å‰æ‰‹é¢œè‰²ï¼šçœ‹è¯•ä¸‹å†å²æœ€åï¼Œæˆ–è€…çœ‹åŸè°±å½“å‰æ­¥
            if(tryHist.length > 0) color = tryHist[tryHist.length-1].c === 1 ? 2 : 1;
            else if(curStep > 0) color = moves[curStep-1].c === 1 ? 2 : 1;
            
            const res = engine.play(x, y, color);
            if(res.success) {
                tryHist.push({x, y, c: color});
                playSound(res.capturedCount > 0);
                board.draw(engine.board, {x, y}); // è¿™é‡Œåªç”»æ–°å­ï¼Œä¸é‡ç»˜æ•´ä¸ªç•Œé¢ä»¥æé«˜æ€§èƒ½
            }
        }
    }

    // å¯¼èˆªå¯¹è±¡
    const nav = {
        next: () => {
            if(curStep < moves.length) {
                const m = moves[curStep];
                const res = engine.play(m.x, m.y, m.c);
                curStep++;
                playSound(res.capturedCount > 0);
                updateUI();
            }
        },
        prev: () => {
            if(curStep > 0) {
                curStep--;
                syncEngine();
                updateUI();
            }
        },
        first: () => { curStep=0; syncEngine(); updateUI(); },
        last: () => { curStep=moves.length; syncEngine(); updateUI(); }
    };

    // è¾…åŠ©å‡½æ•°
    function syncEngine() {
        engine.reset();
        for(let i=0; i<curStep; i++) engine.play(moves[i].x, moves[i].y, moves[i].c);
    }

    function updateBoard() {
        let last = null;
        if(curStep > 0) last = moves[curStep-1];
        board.draw(engine.board, last);
    }

    function updateUI() {
        document.getElementById('step-num').innerText = curStep;
        updateBoard();
        // åªè¦ä¸æ˜¯è¯•ä¸‹æ¨¡å¼ï¼ŒUIæ›´æ–°æ—¶å°±æ¸…ç©ºè¯•ä¸‹å†å²
        if(mode !== 'try') tryHist = [];
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('t-'+m).classList.add('active');
        
        const btns = document.getElementById('play-btns');
        if(m === 'view') {
            btns.style.opacity = 1;
            btns.style.pointerEvents = 'auto';
            // é€€å‡ºè¯•ä¸‹ï¼Œæ¢å¤ç›˜é¢
            if(tryHist.length) { tryHist=[]; syncEngine(); updateBoard(); }
        } else {
            btns.style.opacity = 0.3;
            btns.style.pointerEvents = 'none';
            showMsg(m === 'guess' ? "è¿›å…¥çŒœå±€æ¨¡å¼" : "è¿›å…¥è¯•ä¸‹æ¨¡å¼");
        }
    }

    function showMsg(txt, success) {
        const el = document.getElementById('msg');
        el.innerText = txt;
        el.style.opacity = 1;
        el.style.background = success ? "#27ae60" : "rgba(0,0,0,0.8)";
        setTimeout(() => el.style.opacity = 0, 1000);
    }

    function playSound(isCapture) {
        const aud = isCapture ? sndEat : sndMove;
        aud.currentTime = 0;
        aud.play().catch(e=>{}); // å¿½ç•¥è‡ªåŠ¨æ’­æ”¾é™åˆ¶é”™è¯¯
    }
    
    window.downloadSGF = function() {
        const b = new Blob([sgfStr], {type:'application/x-go-sgf'});
        const u = URL.createObjectURL(b);
        const a = document.createElement('a');
        a.href = u;
        a.download = `${meta.PB||'Black'}_vs_${meta.PW||'White'}.sgf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>
