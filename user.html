<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - çˆ±å›´æ£‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color:#333; }
        .container { max-width: 800px; margin: 30px auto; }
        
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        
        .fav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px; }
        .breadcrumb { font-size: 0.9rem; color: #666; }
        .breadcrumb span { cursor: pointer; color: #2c3e50; font-weight: bold; }
        .breadcrumb span:hover { text-decoration: underline; }
        
        .fav-list { list-style: none; padding: 0; margin: 0; }
        .fav-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: 0.1s; }
        .fav-item:hover { background: #f0f7ff; }
        .fav-icon { margin-right: 10px; font-size: 1.2rem; }
        .fav-name { flex: 1; cursor: pointer; font-weight: 500; }
        
        /* æŒ‰é’®ç»„ */
        .fav-actions { display: none; gap: 5px; }
        .fav-item:hover .fav-actions { display: flex; }
        
        .btn-mini { padding: 4px 8px; font-size: 0.8rem; cursor: pointer; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        .btn-edit { color: #2980b9; border-color: #d6eaf8; background: #ebf5fb; }
        .btn-del { color: #e74c3c; border-color: #fadbd8; background: #fdfefe; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; color: #fff; }
        .btn-primary { background: #2c3e50; }
        .btn-danger { background: #e74c3c; width: 100%; margin-top: 20px;}
    </style>
</head>
<body>

<div class="container">
    <div style="margin-bottom:15px"><a href="index.html" style="color:#666; text-decoration:none;">â† è¿”å›é¦–é¡µ</a></div>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="card">
        <h2>ğŸ‘¤ ä¸ªäººèµ„æ–™</h2>
        <div class="input-group">
            <label>é‚®ç®±</label>
            <input type="text" id="email" disabled style="background:#eee">
        </div>
        <div class="input-group">
            <label>æ˜µç§°</label>
            <input type="text" id="username">
        </div>
        <button class="btn btn-primary" onclick="updateProfile()">ä¿å­˜æ˜µç§°</button>
        <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>

    <!-- æ”¶è—å¤¹ -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="border:none; margin:0;">â­ æˆ‘çš„æ”¶è—å¤¹</h2>
            <button class="btn-mini" id="btn-create-folder" onclick="createFolder()">+ æ–°å»ºæ–‡ä»¶å¤¹</button>
        </div>
        
        <div class="fav-header">
            <div class="breadcrumb" id="breadcrumb">
                <span onclick="loadFavs(null)">æ ¹ç›®å½•</span>
            </div>
        </div>

        <ul class="fav-list" id="fav-list">
            <li style="text-align:center; padding:20px; color:#999;">Loading...</li>
        </ul>
    </div>
</div>

<script src="assets/js/config.js"></script>
<script>
    let userId = null;
    let currentFolderId = null; // null è¡¨ç¤ºæ ¹ç›®å½•
    let currentFolderName = ""; // ç”¨äºé¢åŒ…å±‘æ˜¾ç¤º

    window.onload = async () => {
        const { data: { user } } = await sbClient.auth.getUser();
        if (!user) return location.href = "login.html";
        userId = user.id;
        
        document.getElementById('email').value = user.email;
        const { data: profile } = await sbClient.from('profiles').select('username').eq('id', userId).single();
        if (profile) document.getElementById('username').value = profile.username || "";

        loadFavs(null);
    };

    async function loadFavs(folderId, folderName = "") {
        currentFolderId = folderId;
        currentFolderName = folderName;
        
        // æ›´æ–° UI çŠ¶æ€
        document.getElementById('btn-create-folder').style.display = folderId ? 'none' : 'block'; // åªå…è®¸æ ¹ç›®å½•å»ºæ–‡ä»¶å¤¹
        updateBreadcrumb();

        const list = document.getElementById('fav-list');
        list.innerHTML = '<li style="padding:15px;text-align:center">Loading...</li>';

        let query = sbClient.from('favorites')
            .select('*')
            .eq('user_id', userId)
            .order('is_folder', {ascending: false}) 
            .order('created_at', {ascending: false});
            
        if (folderId) query = query.eq('parent_id', folderId);
        else query = query.is('parent_id', null);

        const { data, error } = await query;
        if (error) return alert(error.message);

        if (data.length === 0) {
            list.innerHTML = '<li style="padding:15px;text-align:center;color:#999">æš‚æ— å†…å®¹</li>';
        } else {
            list.innerHTML = data.map(item => `
                <li class="fav-item">
                    <div class="fav-icon">${item.is_folder ? 'ğŸ“' : 'ğŸ“„'}</div>
                    <div class="fav-name" onclick="${item.is_folder ? `loadFavs('${item.id}', '${item.title}')` : `openGame('${item.game_id}')`}">
                        ${item.title}
                    </div>
                    <div class="fav-actions">
                        <button class="btn-mini btn-edit" onclick="renameItem('${item.id}', '${item.title}')">é‡å‘½å</button>
                        <button class="btn-mini btn-del" onclick="deleteItem('${item.id}', ${item.is_folder})">åˆ é™¤</button>
                    </div>
                </li>
            `).join('');
        }
    }

    function updateBreadcrumb() {
        const bc = document.getElementById('breadcrumb');
        let html = `<span onclick="loadFavs(null)">æ ¹ç›®å½•</span>`;
        if (currentFolderId) {
            html += ` > <span>${currentFolderName}</span>`;
        }
        bc.innerHTML = html;
    }

    function openGame(gameId) {
        window.open(`game/#${gameId}`, '_blank');
    }

    async function createFolder() {
        if (currentFolderId) return alert("åªèƒ½åœ¨æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹");
        const name = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:");
        if (!name) return;

        const { error } = await sbClient.from('favorites').insert({
            user_id: userId,
            title: name,
            is_folder: true,
            parent_id: null
        });

        if (error) alert("åˆ›å»ºå¤±è´¥: " + error.message);
        else loadFavs(null);
    }

    async function renameItem(id, oldName) {
        const newName = prompt("é‡å‘½å:", oldName);
        if (!newName || newName === oldName) return;

        const { error } = await sbClient.from('favorites')
            .update({ title: newName })
            .eq('id', id);

        if (error) alert("é‡å‘½åå¤±è´¥: " + error.message);
        else loadFavs(currentFolderId, currentFolderName);
    }

    async function deleteItem(id, isFolder) {
        if (!confirm(`ç¡®å®šåˆ é™¤æ­¤${isFolder ? 'æ–‡ä»¶å¤¹ï¼ˆåŠå…¶å†…éƒ¨æ‰€æœ‰å†…å®¹ï¼‰' : 'æ”¶è—'}å—ï¼Ÿ`)) return;

        // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦ä¸ºç©ºï¼ˆSupabase å¦‚æœæ²¡è®¾ç½®çº§è”åˆ é™¤ï¼Œç›´æ¥åˆ ä¼šæŠ¥é”™ï¼‰
        // è¿™é‡Œå°è¯•ç›´æ¥åˆ é™¤ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰åœ¨æ•°æ®åº“è®¾çº§è”ï¼Œå‰ç«¯æ‰‹åŠ¨åˆ å¤ªéº»çƒ¦ã€‚
        // å»ºè®®ä½ åœ¨ Supabase SQL åŠ ä¸Š ON DELETE CASCADE (ä¹‹å‰ä»£ç æ²¡åŠ ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç©º)
        // ç®€å•å¤„ç†ï¼šå…ˆåˆ ã€‚
        
        // å°è¯•åˆ é™¤å­é¡¹ (å¦‚æœæ˜¯æ–‡ä»¶å¤¹)
        if (isFolder) {
             await sbClient.from('favorites').delete().eq('parent_id', id);
        }

        const { error } = await sbClient.from('favorites').delete().eq('id', id);
        
        if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
        else loadFavs(currentFolderId, currentFolderName);
    }

    async function updateProfile() {
        const newName = document.getElementById('username').value;
        if(!newName) return;
        await sbClient.from('profiles').update({username: newName}).eq('id', userId);
        alert("å·²ä¿å­˜");
    }

    async function logout() {
        await sbClient.auth.signOut();
        location.href = "index.html";
    }
</script>
</body>
</html>
