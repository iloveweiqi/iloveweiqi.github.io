<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âä†ËΩΩ‰∏≠... - Áà±Âõ¥Ê£ã</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #d4a017; --bg: #f4f6f8; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 30px; }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        header { background: #fff; height: 50px; display: flex; align-items: center; padding: 0 15px; margin-bottom: 10px; border-bottom:1px solid #eee; }
        .back { text-decoration: none; color: #555; font-size: 0.9rem; }
        .info-card { background: #fff; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card h2 { margin: 0 0 5px 0; font-size: 1.3rem; }
        /* Ê£ãÁõòËÉåÊôØËâ≤ */
        .board-box { width: 100%; aspect-ratio: 1/1; background: #eebb76; position: relative; margin-bottom: 15px; border-radius: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        canvas { width: 100%; height: 100%; cursor: pointer; }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s; font-weight: bold; }
        .controls { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabs { display: flex; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; background: #f9f9f9; font-size: 0.9rem; }
        .tab.active { background: var(--primary); color: #fff; }
        .btns { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-size: 1.2rem; cursor: pointer; }
        .btn:active { background: #eee; }
        .nav-btn { padding: 4px 8px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <a href="../index.html" class="back">‚Äπ ËøîÂõûÈ¶ñÈ°µ</a>
    <div style="margin-left:auto; display:flex; align-items:center;" id="auth-box"></div>
</header>

<div class="container">
    <div class="info-card">
        <h2><span id="p-black">--</span> vs <span id="p-white">--</span></h2>
        <div style="color:#666; font-size:0.9rem;"><span id="p-event">--</span> ¬∑ <span id="p-result">--</span></div>
    </div>

    <div class="board-box">
        <canvas id="game-canvas"></canvas>
        <div id="msg" class="overlay">Correct!</div>
    </div>

    <div class="controls">
        <div class="tabs">
            <div class="tab active" onclick="setMode('view')" id="t-view">ÊµèËßà (View)</div>
            <div class="tab" onclick="setMode('guess')" id="t-guess">ÁåúÂ±Ä (Guess)</div>
            <div class="tab" onclick="setMode('try')" id="t-try">ËØï‰∏ã (Try)</div>
        </div>

        <div class="btns" id="play-btns">
            <button class="btn" onclick="nav.first()">|‚Äπ</button>
            <button class="btn" onclick="nav.prev()">‚Äπ</button>
            <button class="btn" onclick="nav.next()">‚Ä∫</button>
            <button class="btn" onclick="nav.last()">‚Ä∫|</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
            <span>ÊâãÊï∞: <span id="step-num" style="font-weight:bold">0</span></span>
            <button onclick="downloadSGF()" style="border:none; background:none; color:#666; text-decoration:underline; cursor:pointer">üì• ‰∏ãËΩΩ SGF</button>
        </div>
    </div>
</div>

<script src="../assets/js/config.js"></script>
<script src="../assets/js/core.js"></script>
<script>
    // Á´ãÂç≥ÂàùÂßãÂåñÊ£ãÁõòÔºå‰øùËØÅËßÜËßâÁßíÂºÄ
    const board = new GoBoard('game-canvas');
    const engine = new GoEngine();
    
    // Áä∂ÊÄÅÂèòÈáè
    let moves = [], curStep = 0, mode = 'view', tryHist = [], meta = {}, sgfStr = "";
    const sndMove = new Audio('../assets/sound/move.wav');
    const sndEat = new Audio('../assets/sound/deadstoneless.wav');

    window.onload = async () => {
        // Ê∏≤Êüì Header (‰º†ÂÖ• ../ Ë°®Á§∫ÂõûÂà∞Ê†πÁõÆÂΩïÊâæÊñá‰ª∂)
        renderHeaderAuth('auth-box', '../');

        // 1. Ëé∑Âèñ ID (‰ºòÂÖàHashÔºåÂÖ∂Ê¨°Query)
        let id = window.location.hash ? window.location.hash.substring(1) : new URLSearchParams(window.location.search).get('id');
        
        if(!id) { alert('Êó†ÊïàID'); return location.href = "../index.html"; }
        
        // 2. Âä†ËΩΩÊï∞ÊçÆ
        const { data, error } = await sbClient.from('games').select('*').eq('id', id).single();
        if(error || !data) { alert('ËØªÂèñÂ§±Ë¥•'); return; }

        // 3. Ëß£Êûê
        sgfStr = data.sgf_content;
        const res = parseSGF(sgfStr);
        moves = res.moves; meta = res.meta;
        
        // 4. Êõ¥Êñ∞UI
        document.getElementById('p-black').innerText = data.black_player;
        document.getElementById('p-white').innerText = data.white_player;
        document.getElementById('p-event').innerText = data.event_name || '-';
        document.getElementById('p-result').innerText = data.result || '-';
        document.title = `${data.black_player} vs ${data.white_player} - ${data.result} - ${data.event_name}`;

        updateBoard();
        board.clickHandler = (x, y) => handleClick(x, y);
    };

    function handleClick(x, y) {
        if(mode === 'view') return;
        if(mode === 'guess') {
            if(curStep >= moves.length) return showMsg("ÁªìÊùü");
            const next = moves[curStep];
            if(next.x === x && next.y === y) { showMsg("Correct!", true); nav.next(); } 
            else showMsg("Wrong!");
        } else if(mode === 'try') {
            let color = 1;
            if(tryHist.length > 0) color = tryHist[tryHist.length-1].c === 1 ? 2 : 1;
            else if(curStep > 0) color = moves[curStep-1].c === 1 ? 2 : 1;
            const res = engine.play(x, y, color);
            if(res.success) {
                tryHist.push({x, y, c: color});
                playSound(res.capturedCount > 0);
                board.draw(engine.board, {x, y});
            }
        }
    }

    const nav = {
        next: () => { if(curStep < moves.length) { const m = moves[curStep]; const res = engine.play(m.x, m.y, m.c); curStep++; playSound(res.capturedCount>0); updateUI(); } },
        prev: () => { if(curStep > 0) { curStep--; syncEngine(); updateUI(); } },
        first: () => { curStep=0; syncEngine(); updateUI(); },
        last: () => { curStep=moves.length; syncEngine(); updateUI(); }
    };

    function syncEngine() { engine.reset(); for(let i=0; i<curStep; i++) engine.play(moves[i].x, moves[i].y, moves[i].c); }
    function updateBoard() { let last = curStep>0 ? moves[curStep-1] : null; board.draw(engine.board, last); }
    function updateUI() { document.getElementById('step-num').innerText = curStep; updateBoard(); if(mode!=='try') tryHist=[]; }
    function setMode(m) {
        mode = m; document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.getElementById('t-'+m).classList.add('active');
        const btns = document.getElementById('play-btns');
        if(m==='view') { btns.style.opacity=1; btns.style.pointerEvents='auto'; if(tryHist.length){tryHist=[];syncEngine();updateBoard();} } 
        else { btns.style.opacity=0.3; btns.style.pointerEvents='none'; showMsg(m==='guess'?"ÁåúÂ±ÄÊ®°Âºè":"ËØï‰∏ãÊ®°Âºè"); }
    }
    function showMsg(txt, s) { const el=document.getElementById('msg'); el.innerText=txt; el.style.opacity=1; el.style.background=s?"#27ae60":"rgba(0,0,0,0.8)"; setTimeout(()=>el.style.opacity=0,1000); }
    function playSound(c) { const a=c?sndEat:sndMove; a.currentTime=0; a.play().catch(e=>{}); }
    window.downloadSGF = function() { const b=new Blob([sgfStr],{type:'application/x-go-sgf'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`${meta.PB||'B'}_vs_${meta.PW||'W'}.sgf`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
</script>
</body>
</html>
